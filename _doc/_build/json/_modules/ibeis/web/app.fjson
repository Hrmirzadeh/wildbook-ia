{"parents": [{"link": "../../../", "title": "Module code"}, {"link": "../../", "title": "ibeis"}], "title": "ibeis.web.app", "body": "<h1>Source code for ibeis.web.app</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"c1\"># -*- coding: utf-8 -*-</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">Dependencies: flask, tornado</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"kn\">from</span> <span class=\"nn\">__future__</span> <span class=\"k\">import</span> <span class=\"n\">absolute_import</span><span class=\"p\">,</span> <span class=\"n\">division</span><span class=\"p\">,</span> <span class=\"n\">print_function</span>\n<span class=\"kn\">import</span> <span class=\"nn\">tornado.wsgi</span>\n<span class=\"kn\">import</span> <span class=\"nn\">tornado.httpserver</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">socket</span>\n<span class=\"kn\">from</span> <span class=\"nn\">ibeis.control</span> <span class=\"k\">import</span> <span class=\"n\">controller_inject</span>\n<span class=\"kn\">from</span> <span class=\"nn\">ibeis.web</span> <span class=\"k\">import</span> <span class=\"n\">apis_engine</span>\n<span class=\"kn\">from</span> <span class=\"nn\">ibeis.web</span> <span class=\"k\">import</span> <span class=\"n\">job_engine</span>\n<span class=\"kn\">from</span> <span class=\"nn\">ibeis.web</span> <span class=\"k\">import</span> <span class=\"n\">appfuncs</span> <span class=\"k\">as</span> <span class=\"n\">appf</span>\n<span class=\"kn\">from</span> <span class=\"nn\">tornado.log</span> <span class=\"k\">import</span> <span class=\"n\">access_log</span>\n<span class=\"kn\">import</span> <span class=\"nn\">utool</span> <span class=\"k\">as</span> <span class=\"nn\">ut</span>\n\n\n<div class=\"viewcode-block\" id=\"tst_html_error\"><a class=\"viewcode-back\" href=\"../../../../ibeis.web/#ibeis.web.app.tst_html_error\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">tst_html_error</span><span class=\"p\">():</span>\n    <span class=\"sa\">r</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This test will show what our current errors look like</span>\n\n<span class=\"sd\">    CommandLine:</span>\n<span class=\"sd\">        python -m ibeis.web.app --exec-tst_html_error</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>\n<span class=\"sd\">        &gt;&gt;&gt; from ibeis.web.app import *  # NOQA</span>\n<span class=\"sd\">        &gt;&gt;&gt; import ibeis</span>\n<span class=\"sd\">        &gt;&gt;&gt; web_ibs = ibeis.opendb_bg_web(browser=True, start_job_queue=False, url_suffix=&#39;/api/image/imagesettext/?__format__=True&#39;)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">pass</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TimedWSGIContainer\"><a class=\"viewcode-back\" href=\"../../../../ibeis.web/#ibeis.web.app.TimedWSGIContainer\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TimedWSGIContainer</span><span class=\"p\">(</span><span class=\"n\">tornado</span><span class=\"o\">.</span><span class=\"n\">wsgi</span><span class=\"o\">.</span><span class=\"n\">WSGIContainer</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_log</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">400</span><span class=\"p\">:</span>\n            <span class=\"n\">log_method</span> <span class=\"o\">=</span> <span class=\"n\">access_log</span><span class=\"o\">.</span><span class=\"n\">info</span>\n        <span class=\"k\">elif</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">500</span><span class=\"p\">:</span>\n            <span class=\"n\">log_method</span> <span class=\"o\">=</span> <span class=\"n\">access_log</span><span class=\"o\">.</span><span class=\"n\">warning</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">log_method</span> <span class=\"o\">=</span> <span class=\"n\">access_log</span><span class=\"o\">.</span><span class=\"n\">error</span>\n\n        <span class=\"n\">timestamp</span> <span class=\"o\">=</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">timestamp</span><span class=\"p\">()</span>\n        <span class=\"n\">request_time</span> <span class=\"o\">=</span> <span class=\"mf\">1000.0</span> <span class=\"o\">*</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">request_time</span><span class=\"p\">()</span>\n        <span class=\"n\">log_method</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;WALL=</span><span class=\"si\">%s</span><span class=\"s2\"> STATUS=</span><span class=\"si\">%s</span><span class=\"s2\"> METHOD=</span><span class=\"si\">%s</span><span class=\"s2\"> URL=</span><span class=\"si\">%s</span><span class=\"s2\"> IP=</span><span class=\"si\">%s</span><span class=\"s2\"> TIME=</span><span class=\"si\">%.2f</span><span class=\"s2\">ms&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">timestamp</span><span class=\"p\">,</span>\n            <span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">method</span><span class=\"p\">,</span>\n            <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">uri</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">remote_ip</span><span class=\"p\">,</span> <span class=\"n\">request_time</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"start_tornado\"><a class=\"viewcode-back\" href=\"../../../../ibeis.web/#ibeis.web.app.start_tornado\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">start_tornado</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">browser</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">url_suffix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n                  <span class=\"n\">start_web_loop</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">fallback</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Initialize the web server&quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">browser</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">browser</span> <span class=\"o\">=</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">get_argflag</span><span class=\"p\">(</span><span class=\"s1\">&#39;--browser&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">url_suffix</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">url_suffix</span> <span class=\"o\">=</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">get_argval</span><span class=\"p\">(</span><span class=\"s1\">&#39;--url&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_start_tornado</span><span class=\"p\">(</span><span class=\"n\">ibs_</span><span class=\"p\">,</span> <span class=\"n\">port_</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Get Flask app</span>\n        <span class=\"n\">app</span> <span class=\"o\">=</span> <span class=\"n\">controller_inject</span><span class=\"o\">.</span><span class=\"n\">get_flask_app</span><span class=\"p\">()</span>\n        <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">ibs</span> <span class=\"o\">=</span> <span class=\"n\">ibs_</span>\n        <span class=\"c1\"># Try to ascertain the socket&#39;s domain name</span>\n        <span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">setdefaulttimeout</span><span class=\"p\">(</span><span class=\"mf\">0.1</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_domain</span> <span class=\"o\">=</span> <span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">gethostbyname</span><span class=\"p\">(</span><span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">gethostname</span><span class=\"p\">())</span>\n        <span class=\"k\">except</span> <span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">gaierror</span><span class=\"p\">:</span>\n            <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_domain</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;127.0.0.1&#39;</span>\n        <span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">setdefaulttimeout</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_port</span> <span class=\"o\">=</span> <span class=\"n\">port_</span>\n        <span class=\"c1\"># URL for the web instance</span>\n        <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;http://</span><span class=\"si\">%s</span><span class=\"s1\">:</span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_domain</span><span class=\"p\">,</span> <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_port</span><span class=\"p\">)</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] Tornado server starting at </span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_url</span><span class=\"p\">,))</span>\n        <span class=\"c1\"># Launch the web browser to view the web interface and API</span>\n        <span class=\"k\">if</span> <span class=\"n\">browser</span><span class=\"p\">:</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_url</span> <span class=\"o\">+</span> <span class=\"n\">url_suffix</span>\n            <span class=\"kn\">import</span> <span class=\"nn\">webbrowser</span>\n            <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] opening browser with url = </span><span class=\"si\">%r</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,))</span>\n            <span class=\"n\">webbrowser</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Start the tornado web handler</span>\n        <span class=\"c1\"># WSGI = Web Server Gateway Interface</span>\n        <span class=\"c1\"># WSGI is Python standard described in detail in PEP 3333</span>\n        <span class=\"n\">wsgi_container</span> <span class=\"o\">=</span> <span class=\"n\">TimedWSGIContainer</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># # Try wrapping with newrelic performance monitoring</span>\n        <span class=\"c1\"># try:</span>\n        <span class=\"c1\">#     import newrelic</span>\n        <span class=\"c1\">#     wsgi_container = newrelic.agent.WSGIApplicationWrapper(wsgi_container)</span>\n        <span class=\"c1\"># except (ImportError, AttributeError):</span>\n        <span class=\"c1\">#     pass</span>\n\n        <span class=\"n\">http_server</span> <span class=\"o\">=</span> <span class=\"n\">tornado</span><span class=\"o\">.</span><span class=\"n\">httpserver</span><span class=\"o\">.</span><span class=\"n\">HTTPServer</span><span class=\"p\">(</span><span class=\"n\">wsgi_container</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">http_server</span><span class=\"o\">.</span><span class=\"n\">listen</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_port</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">:</span>\n            <span class=\"n\">fallback_port</span> <span class=\"o\">=</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">find_open_port</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_port</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">fallback</span><span class=\"p\">:</span>\n                <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Port </span><span class=\"si\">%s</span><span class=\"s1\"> is unavailable, using fallback_port = </span><span class=\"si\">%r</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">port</span><span class=\"p\">,</span> <span class=\"n\">fallback_port</span><span class=\"p\">,</span> <span class=\"p\">))</span>\n                <span class=\"n\">start_tornado</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"n\">fallback_port</span><span class=\"p\">,</span> <span class=\"n\">browser</span><span class=\"o\">=</span><span class=\"n\">browser</span><span class=\"p\">,</span>\n                              <span class=\"n\">url_suffix</span><span class=\"o\">=</span><span class=\"n\">url_suffix</span><span class=\"p\">,</span> <span class=\"n\">start_web_loop</span><span class=\"o\">=</span><span class=\"n\">start_web_loop</span><span class=\"p\">,</span>\n                              <span class=\"n\">fallback</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">RuntimeError</span><span class=\"p\">(</span>\n                    <span class=\"p\">((</span><span class=\"s1\">&#39;The specified IBEIS web port </span><span class=\"si\">%d</span><span class=\"s1\"> is not available, &#39;</span>\n                      <span class=\"s1\">&#39;but </span><span class=\"si\">%d</span><span class=\"s1\"> is&#39;</span><span class=\"p\">)</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">server_port</span><span class=\"p\">,</span> <span class=\"n\">fallback_port</span><span class=\"p\">)))</span>\n        <span class=\"k\">if</span> <span class=\"n\">start_web_loop</span><span class=\"p\">:</span>\n            <span class=\"n\">tornado</span><span class=\"o\">.</span><span class=\"n\">ioloop</span><span class=\"o\">.</span><span class=\"n\">IOLoop</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Set logging level</span>\n    <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">setLevel</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">INFO</span><span class=\"p\">)</span>\n    <span class=\"c1\"># Get the port if unspecified</span>\n    <span class=\"k\">if</span> <span class=\"n\">port</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">port</span> <span class=\"o\">=</span> <span class=\"n\">appf</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_WEB_API_PORT</span>\n    <span class=\"c1\"># Launch the web handler</span>\n    <span class=\"n\">_start_tornado</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"start_from_ibeis\"><a class=\"viewcode-back\" href=\"../../../../ibeis.web/#ibeis.web.app.start_from_ibeis\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">start_from_ibeis</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">browser</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">precache</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n                     <span class=\"n\">url_suffix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">start_job_queue</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n                     <span class=\"n\">start_web_loop</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Parse command line options and start the server.</span>\n\n<span class=\"sd\">    CommandLine:</span>\n<span class=\"sd\">        python -m ibeis --db PZ_MTEST --web</span>\n<span class=\"sd\">        python -m ibeis --db PZ_MTEST --web --browser</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] start_from_ibeis()&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">start_job_queue</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">get_argflag</span><span class=\"p\">(</span><span class=\"s1\">&#39;--noengine&#39;</span><span class=\"p\">):</span>\n            <span class=\"n\">start_job_queue</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">start_job_queue</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">precache</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">precache</span> <span class=\"o\">=</span> <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">get_argflag</span><span class=\"p\">(</span><span class=\"s1\">&#39;--precache&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">precache</span><span class=\"p\">:</span>\n        <span class=\"n\">gid_list</span> <span class=\"o\">=</span> <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">get_valid_gids</span><span class=\"p\">()</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] Pre-computing all image thumbnails (with annots)...&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">get_image_thumbpath</span><span class=\"p\">(</span><span class=\"n\">gid_list</span><span class=\"p\">,</span> <span class=\"n\">draw_annots</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] Pre-computing all image thumbnails (without annots)...&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">get_image_thumbpath</span><span class=\"p\">(</span><span class=\"n\">gid_list</span><span class=\"p\">,</span> <span class=\"n\">draw_annots</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] Pre-computing all annotation chips...&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">check_chip_existence</span><span class=\"p\">()</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">compute_all_chips</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">start_job_queue</span><span class=\"p\">:</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] opening job manager&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">load_plugin_module</span><span class=\"p\">(</span><span class=\"n\">job_engine</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">load_plugin_module</span><span class=\"p\">(</span><span class=\"n\">apis_engine</span><span class=\"p\">)</span>\n        <span class=\"c1\">#import time</span>\n        <span class=\"c1\">#time.sleep(1)</span>\n        <span class=\"c1\"># No need to sleep, this call should block until engine is live.</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">initialize_job_manager</span><span class=\"p\">()</span>\n        <span class=\"c1\">#time.sleep(10)</span>\n\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] starting tornado&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">start_tornado</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"p\">,</span> <span class=\"n\">browser</span><span class=\"p\">,</span> <span class=\"n\">url_suffix</span><span class=\"p\">,</span> <span class=\"n\">start_web_loop</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"ne\">KeyboardInterrupt</span><span class=\"p\">:</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Caught ctrl+c in webserver. Gracefully exiting&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">start_web_loop</span><span class=\"p\">:</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;[web] closing job manager&#39;</span><span class=\"p\">)</span>\n        <span class=\"n\">ibs</span><span class=\"o\">.</span><span class=\"n\">close_job_manager</span><span class=\"p\">()</span></div>\n\n\n<div class=\"viewcode-block\" id=\"start_web_annot_groupreview\"><a class=\"viewcode-back\" href=\"../../../../ibeis.web/#ibeis.web.app.start_web_annot_groupreview\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">start_web_annot_groupreview</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">aid_list</span><span class=\"p\">):</span>\n    <span class=\"sa\">r</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        ibs (IBEISController):  ibeis controller object</span>\n<span class=\"sd\">        aid_list (list):  list of annotation rowids</span>\n\n<span class=\"sd\">    CommandLine:</span>\n<span class=\"sd\">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db PZ_Master1</span>\n<span class=\"sd\">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db GZ_Master1</span>\n<span class=\"sd\">        python -m ibeis.tag_funcs --exec-start_web_annot_groupreview --db GIRM_Master1</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; # SCRIPT</span>\n<span class=\"sd\">        &gt;&gt;&gt; from ibeis.tag_funcs import *  # NOQA</span>\n<span class=\"sd\">        &gt;&gt;&gt; import ibeis</span>\n<span class=\"sd\">        &gt;&gt;&gt; #ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;GZ_Master1&#39;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; #aid_list = ibs.get_valid_aids()</span>\n<span class=\"sd\">        &gt;&gt;&gt; # -----</span>\n<span class=\"sd\">        &gt;&gt;&gt; any_tags = ut.get_argval(&#39;--tags&#39;, type_=list, default=[&#39;Viewpoint&#39;])</span>\n<span class=\"sd\">        &gt;&gt;&gt; min_num = ut.get_argval(&#39;--min_num&#39;, type_=int, default=1)</span>\n<span class=\"sd\">        &gt;&gt;&gt; prop = any_tags[0]</span>\n<span class=\"sd\">        &gt;&gt;&gt; filtered_annotmatch_rowids = filter_annotmatch_by_tags(ibs, None, any_tags=any_tags, min_num=min_num)</span>\n<span class=\"sd\">        &gt;&gt;&gt; aid1_list = (ibs.get_annotmatch_aid1(filtered_annotmatch_rowids))</span>\n<span class=\"sd\">        &gt;&gt;&gt; aid2_list = (ibs.get_annotmatch_aid2(filtered_annotmatch_rowids))</span>\n<span class=\"sd\">        &gt;&gt;&gt; aid_list = list(set(ut.flatten([aid2_list, aid1_list])))</span>\n<span class=\"sd\">        &gt;&gt;&gt; result = start_web_annot_groupreview(ibs, aid_list)</span>\n<span class=\"sd\">        &gt;&gt;&gt; print(result)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">ibeis.web</span>\n    <span class=\"n\">aid_strs</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;,&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">aid_list</span><span class=\"p\">)))</span>\n    <span class=\"n\">url_suffix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;/group_review/?aid_list=</span><span class=\"si\">%s</span><span class=\"s1\">&#39;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">aid_strs</span><span class=\"p\">)</span>\n    <span class=\"n\">ibeis</span><span class=\"o\">.</span><span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">start_from_ibeis</span><span class=\"p\">(</span><span class=\"n\">ibs</span><span class=\"p\">,</span> <span class=\"n\">url_suffix</span><span class=\"o\">=</span><span class=\"n\">url_suffix</span><span class=\"p\">,</span> <span class=\"n\">browser</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">if</span> <span class=\"vm\">__name__</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;__main__&#39;</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    CommandLine:</span>\n<span class=\"sd\">        python -m ibeis.web.app</span>\n<span class=\"sd\">        python -m ibeis.web.app --allexamples</span>\n<span class=\"sd\">        python -m ibeis.web.app --allexamples --noface --nosrc</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">multiprocessing</span>\n    <span class=\"n\">multiprocessing</span><span class=\"o\">.</span><span class=\"n\">freeze_support</span><span class=\"p\">()</span>  <span class=\"c1\"># for win32</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">utool</span> <span class=\"k\">as</span> <span class=\"nn\">ut</span>  <span class=\"c1\"># NOQA</span>\n    <span class=\"n\">ut</span><span class=\"o\">.</span><span class=\"n\">doctest_funcs</span><span class=\"p\">()</span>\n</pre></div>", "current_page_name": "_modules/ibeis/web/app", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}